###################
# Specify project #
###################
#
# Name of project
#
PROJECT = sorpPropLib


# Specify build release:
#
# YES: Disable debugging information and optimize code
# NO: Debugging information
#
BUILD_RELEASE = YES


# Names of sources
#	
SOURCES_LIB = $(addprefix $(DIR_SRC)/,\
	json_interface.c\
	cJSON.c\
	adsorption.c\
	adsorption_dualSiteSips.c\
	adsorption_langmuir.c\
	adsorption_toth.c\
	adsorption_dubininAstakhov.c\
	absorption_duehring.c\
	absorption_activity_wilson.c\
	absorption_activity_nrtl.c\
	absorption_activity_uniquac.c\
	refrigerant.c\
	refrigerant_vapourPressure.c\
	refrigerant_saturatedLiquidDensity.c)

SOURCES = $(SOURCES_LIB) $(DIR_SRC)/workingPair.c


# Names of objects generated automatically:
#
# 1) Substitute path "src" with "obj"
# 2) Substitute extension ".c" with ".o"
#
TMP_OBJECTS_LIB = $(subst src,obj,$(SOURCES_LIB))
OBJECTS_LIB = $(TMP_OBJECTS_LIB:%.c=%.o)

TMP_OBJECTS = $(subst src,obj,$(SOURCES))
OBJECTS = $(TMP_OBJECTS:%.c=%.o)




#################
# Specify paths #
#################
#
# Top directory
#
DIR_TOP 	= $(CURDIR)


# Subdirectories
#
DIR_INCL 	= $(DIR_TOP)/incl
DIR_SRC 	= $(DIR_TOP)/src
DIR_OBJ 	= $(DIR_TOP)/obj
DIR_LIB 	= $(DIR_TOP)/lib
DIR_TEST 	= $(DIR_TOP)/test




####################
# Specify programs #
####################
#
# C compiler
#
CC		= gcc


# Library
#
LIBRARY	= ar




###########################
# Specify program options #
###########################
#
# C compiler options
#
FLAGS_CC 		= -c
FLAGS_CC_OBJ	= $(FLAGS_CC_BUILD_DEBUG) -I $(DIR_INCL)/ -o $(DIR_OBJ)/


# Library options
#
FLAGS_LIBRARY_STATIC	= -rcs $(DIR_LIB)/lib$(PROJECT)_static.a 
FLAGS_LIBRARY_DYNAMIC	= -shared -o $(DIR_LIB)/lib$(PROJECT).dll\
	-Wl,--out-implib,$(DIR_LIB)/lib$(PROJECT).a


# Program options depending on build
# or debug release /Zi
#
ifeq ($(BUILD_RELEASE),YES)
FLAGS_CC_BUILD_DEBUG = -Ofast
FLAGS_LINK_BUILD_DEBUG = 
else
FLAGS_CC_BUILD_DEBUG = -Og -Wall -Wextra -Werror
FLAGS_LINK_BUILD_DEBUG = /DEBUG
endif




##########################
# Specify explicit rules #
##########################
#
# Test all files
#
all: $(DIR_SRC)/cJSON.c\
	test_refrigerants\
	test_adsorption\
	test_absorption\
	test_workingPair\
	test_libraries

	
# Execute test scripts for refrigerants
#
test_refrigerants: test_refrigerant_vapourPressure.exe\
	test_refrigerant_saturatedLiquidDensity.exe\
	test_refrigerant.exe

	$(DIR_TEST)/test_refrigerant_vapourPressure.exe
	$(DIR_TEST)/test_refrigerant_saturatedLiquidDensity.exe
	$(DIR_TEST)/test_refrigerant.exe


# Execute test scripts for adsorption
#
test_adsorption: test_adsorption_dualSiteSips.exe\
	test_adsorption_langmuir.exe\
	test_adsorption_toth.exe\
	test_adsorption_dubininAstakhov.exe\
	test_adsorption.exe

	$(DIR_TEST)/test_adsorption_dualSiteSips.exe
	$(DIR_TEST)/test_adsorption_langmuir.exe
	$(DIR_TEST)/test_adsorption_toth.exe
	$(DIR_TEST)/test_adsorption_dubininAstakhov.exe
	$(DIR_TEST)/test_adsorption.exe


# Execute test scripts for absorption
#
test_absorption: test_absorption_duehring.exe\
	test_absorption_activity_wilson.exe\
	test_absorption_activity_nrtl.exe\
	test_absorption_activity_uniquac.exe

	$(DIR_TEST)/test_absorption_duehring.exe
	$(DIR_TEST)/test_absorption_activity_wilson.exe
	$(DIR_TEST)/test_absorption_activity_nrtl.exe
	$(DIR_TEST)/test_absorption_activity_uniquac.exe
	
	
# Execute test scripts for refrigerants
#
test_workingPair: $(DIR_SRC)/cJSON.c\
	test_workingPair.exe
	
	$(DIR_TEST)/test_workingPair.exe
	
	
# Execute test scripts for libraries
#
test_libraries: $(DIR_SRC)/cJSON.c\
	test_workingPair_staticLibrary.exe\
	test_workingPair_DLL.exe

	$(DIR_TEST)/test_workingPair_staticLibrary.exe
	cp "$(DIR_LIB)/lib$(PROJECT).dll" "$(DIR_TOP)/lib$(PROJECT).dll"
	$(DIR_TEST)/test_workingPair_DLL.exe
	rm "$(DIR_TOP)/lib$(PROJECT).dll"


# Update external libraries:
# 1.) cJSON
#
$(DIR_SRC)/cJSON.c: $(DIR_LIB)/cJSON/cJSON.c
	cp "$(DIR_LIB)/cJSON/cJSON.h" "$(DIR_INCL)/cJSON.h"
	cp "$(DIR_LIB)/cJSON/cJSON.c" "$(DIR_SRC)/cJSON.c"


# Create internal libraries:
# 0.) Create libraries
# 1.) static
# 2.) dynamic
#
create_libraries: $(DIR_LIB)/lib$(PROJECT)_static.a\
	$(DIR_LIB)/lib$(PROJECT).dll


$(DIR_LIB)/lib$(PROJECT)_static.a: $(OBJECTS)
	$(LIBRARY) $(FLAGS_LIBRARY_STATIC) $?
	
$(DIR_LIB)/lib$(PROJECT).dll: $(DIR_OBJ)/workingPair_dll.o $(OBJECTS_LIB)
	$(CC) $(FLAGS_LIBRARY_DYNAMIC) $?

$(DIR_OBJ)/workingPair_dll.o: $(DIR_SRC)/workingPair.c
	$(CC) $(FLAGS_CC) -D DLL_EXPORTS $< $(FLAGS_CC_OBJ)$(@F)


# Create test scripts
#
test_refrigerant_vapourPressure.exe: $(addprefix $(DIR_OBJ)/,\
	test_refrigerant_vapourPressure.o refrigerant_vapourPressure.o)
	$(CC) $? -o $(DIR_TEST)/$(@F)

test_refrigerant_saturatedLiquidDensity.exe: $(addprefix $(DIR_OBJ)/,\
	test_refrigerant_saturatedLiquidDensity.o\
	refrigerant_saturatedLiquidDensity.o)
	$(CC) $? -o $(DIR_TEST)/$(@F)

test_refrigerant.exe: $(addprefix $(DIR_OBJ)/,\
	test_refrigerant.o refrigerant.o\
	refrigerant_vapourPressure.o refrigerant_saturatedLiquidDensity.o)
	$(CC) $? -o $(DIR_TEST)/$(@F)


test_adsorption_dualSiteSips.exe: $(addprefix $(DIR_OBJ)/,\
	test_adsorption_dualSiteSips.o adsorption_dualSiteSips.o)
	$(CC) $? -o $(DIR_TEST)/$(@F)

test_adsorption_langmuir.exe: $(addprefix $(DIR_OBJ)/,\
	test_adsorption_langmuir.o adsorption_langmuir.o)
	$(CC) $? -o $(DIR_TEST)/$(@F)

test_adsorption_toth.exe: $(addprefix $(DIR_OBJ)/,\
	test_adsorption_toth.o adsorption_toth.o)
	$(CC) $? -o $(DIR_TEST)/$(@F)

test_adsorption_dubininAstakhov.exe: $(addprefix $(DIR_OBJ)/,\
	test_adsorption_dubininAstakhov.o adsorption_dubininAstakhov.o\
	refrigerant_vapourPressure.o refrigerant_saturatedLiquidDensity.o\
	refrigerant.o)
	$(CC) $? -o $(DIR_TEST)/$(@F)

test_adsorption.exe: $(addprefix $(DIR_OBJ)/,\
	test_adsorption.o adsorption.o\
	adsorption_dualSiteSips.o adsorption_langmuir.o adsorption_toth.o\
	adsorption_dubininAstakhov.o\
	refrigerant_vapourPressure.o refrigerant_saturatedLiquidDensity.o\
	refrigerant.o)
	$(CC) $? -o $(DIR_TEST)/$(@F)


test_absorption_duehring.exe: $(addprefix $(DIR_OBJ)/,\
	test_absorption_duehring.o absorption_duehring.o)
	$(CC) $? -o $(DIR_TEST)/$(@F)

test_absorption_activity_wilson.exe: $(addprefix $(DIR_OBJ)/,\
	test_absorption_activity_wilson.o absorption_activity_wilson.o\
	refrigerant_vapourPressure)
	$(CC) $? -o $(DIR_TEST)/$(@F)

test_absorption_activity_nrtl.exe: $(addprefix $(DIR_OBJ)/,\
	test_absorption_activity_nrtl.o absorption_activity_nrtl.o\
	refrigerant_vapourPressure)
	$(CC) $? -o $(DIR_TEST)/$(@F)

test_absorption_activity_uniquac.exe: $(addprefix $(DIR_OBJ)/,\
	test_absorption_activity_uniquac.o absorption_activity_uniquac.o\
	refrigerant_vapourPressure)
	$(CC) $? -o $(DIR_TEST)/$(@F)


test_workingPair.exe: $(DIR_OBJ)/test_workingPair.o $(OBJECTS)
	$(CC) $? -o $(DIR_TEST)/$(@F)


test_workingPair_staticLibrary.exe: $(DIR_OBJ)/test_workingPair_staticLibrary.o\
	$(DIR_LIB)/lib$(PROJECT)_static.a
	$(CC) $< -L $(DIR_LIB) -l $(PROJECT)_static -o $(DIR_TEST)/$(@F)

test_workingPair_DLL.exe: $(DIR_OBJ)/test_workingPair_DLL.o\
	$(DIR_LIB)/lib$(PROJECT).dll 
	$(CC) $< -L $(DIR_LIB) -l $(PROJECT) -o $(DIR_TEST)/$(@F)




###########################
# Specify inference rules #
###########################	
#
# Update object-files that
# depend on source files
#
$(DIR_OBJ)/%.o: $(DIR_SRC)/%.c
	$(CC) $(FLAGS_CC) $< $(FLAGS_CC_OBJ)$(@F)
